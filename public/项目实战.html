<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vs-tree2.0_项目实战</title>
  <link rel="stylesheet" href="../dist/vs-tree.css">
  <link rel="stylesheet" href="./static/css/index.css">
</head>

<body>
  <div>用时：<span id="usetime"></span></div>
  <div id="tree" class="tree-demo"></div>
  <button id="checked" type="button">获取选中元素</button>
  <script>
    console.time('create:data')
    var list = []
    var xhr = new XMLHttpRequest()
    xhr.open('GET', './static/data.txt', true)
    xhr.send()
    xhr.onload = function (e) {
      list = xhr.response.split('\r\n').map(v => v && JSON.parse(v))
      var data = list.filter(v => v && v.obj === 'department' && v.data.pdid === '-1')
      console.timeEnd('create:data')
      init(data)
    }
  </script>
  <script src="../dist/vs-tree.js"></script>
  <script>
    var tree;
    function init (data) {
      console.time('render:tree');
      var time = Date.now()
      const umap = {}
      const infomap = {}
      list.forEach(v => {
        if (v.obj === 'department_user') {
          if (umap[v.data.did]) {
            umap[v.data.did].push(v.data)
          } else {
            umap[v.data.did] = [v.data]
          }
        } else if (v.obj === 'user') {
          infomap[v.data.uid] = v.data
        }
      })
      tree = new vsTree.default('#tree', {
        data: data[0],
        showCheckbox: true,
        max: 988,
        checkFilter: function (node) {
          return node.isLeaf
        },
        limitAlert: function() {
          alert('超过最大可选')
        },
        format: function(data) {
          var child = []
          if (data.obj === 'department') {
            child = list.filter(v => v.obj === 'department' && v.data.pdid === data.data.did)
            child = child.concat(umap[data.data.did] || [])
            return {
              name: data.data.name || '---',
              children: child
            }
          }
          return {
            name: infomap[data.uid] && infomap[data.uid].name,
            isLeaf: true,
            children: []
          }
        },
        renderContent: function (h, node) {
          if (node.data.obj !== 'department') {
            return false
          }
          const count = getCount(umap, node)
          node.hasChildCount = count
          return h("div", {
            className: "tree-action",
            children: [
              h("span", {
                text: `（${count}）`
              })
            ]
          })
        }
      });
      console.timeEnd('render:tree');
      document.getElementById('usetime').innerHTML = Date.now() - time + 'ms'
    }

    function getCount(umap, node) {
      if (!umap[node.data.data.did]) return 0
      let count = 0
      const calc = (node) => {
        if (node.data.obj !== 'department') return
        count += (umap[node.data.data.did] && umap[node.data.data.did].length) || 0
        if (node.childNodes) {
          node.childNodes.forEach(v => {
            calc(v)
          })
        }
      }
      calc(node)
      return count
    }

    document.getElementById("checked").onclick = function () {
      console.log(tree);
      console.log(tree.getCheckedNodes());
    }
  </script>
</body>

</html>